import os
import pandas as pd
import asyncio
from engine.api_client import call_llm
from tqdm.asyncio import tqdm_asyncio
from optimizer.metrics import evaluate_correction
from typing import List, Dict
from dotenv import load_dotenv
from openai import OpenAI

from openai import OpenAI

def get_upstage_token_count(texts: list[str], api_key: str, model: str = "embedding-passage") -> int:
    client = OpenAI(
        api_key=api_key,
        base_url="https://api.upstage.ai/v1"
    )

    response = client.embeddings.create(
        model=model,
        input=texts
    )

    return response.usage.prompt_tokens  # âœ… ì—¬ê¸° ìˆ˜ì •ë¨


# í…œí”Œë¦¿ ì ìš© (Multi-turn)
def apply_template(template_name: str, text: str) -> List[Dict]:
    rule_text = (
        "ë„ˆëŠ” í•œêµ­ì–´ ë¬¸ì¥ì˜ ì˜¤íƒˆì, ë„ì–´ì“°ê¸°, ë¬¸ì¥ë¶€í˜¸ ì˜¤ë¥˜ë¥¼ ì •ë°€í•˜ê²Œ êµì •í•˜ëŠ” ì „ë¬¸ê°€ì•¼. "
        "ì…ë ¥ ë¬¸ì¥ì˜ ì˜ë¯¸, ì–´íˆ¬, ë§íˆ¬ëŠ” **ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ê³ **, ì˜¤ì§ ì˜ëª»ëœ ë¶€ë¶„ë§Œ ìˆ˜ì •í•´ì•¼ í•´.\n\n"

        "ğŸ“Œ **êµì • ì›ì¹™**\n"
        "1. **ì˜¤íƒˆì(ì² ì ì˜¤ë¥˜)**\n"
        "- ìíŒ ì‹¤ìˆ˜, ì² ì ì˜¤ë¥˜, ììŒ/ëª¨ìŒ í˜¼ë™, ìœ ì‚¬í•œ ì² ìë‚˜ ë°œìŒìœ¼ë¡œ ì¸í•œ í˜¼ë™ì„ ê³ ì³ì¤˜. ì˜ˆ: 'ë¬ë‹¤' â†’ 'ëë‹¤'\n"
        "- ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì˜ë„ê°€ ë¶ˆë¶„ëª…í•œ ë‹¨ì–´ëŠ” ë¬¸ë§¥ìƒ ìì—°ìŠ¤ëŸ½ê³  ì •í™•í•œ ë‹¨ì–´ë¡œ ìˆ˜ì •í•´ì¤˜.\n"
        "- ë‹¨ì–´ëŠ” ì¡´ì¬í•˜ì§€ë§Œ ë¬¸ë§¥ì— ë¶€ìì—°ìŠ¤ëŸ¬ìš´ ê²½ìš°, ê°€ì¥ ì ì ˆí•œ ë‹¨ì–´ë¡œ ë°”ê¿”ì¤˜. ë‹¨, ì˜ë¯¸ê°€ ìœ ì§€ë˜ì–´ì•¼ í•´.\n\n"

        "2. **ë„ì–´ì“°ê¸°**\n"
        "- ë„ì–´ì“°ê¸°ëŠ” ì˜ë¯¸ ë‹¨ìœ„ì™€ ë¬¸ë²• ë‹¨ìœ„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ êµì •í•´ì•¼ í•´.\n"
        "- ë‹¤ìŒ ë‹¨ì–´ëŠ” ë°˜ë“œì‹œ **ë„ì–´ ì¨ì•¼ í•´**:\n"
        "  Â· 'ì¡°íšŒ ìˆ˜', 'ì „ê³µ ìˆ˜ì—…', 'í–‰ë™ ê°•ë ¹', 'ìˆ˜ëŠ¥ ë¬¸í•™', 'ìƒ¤í”„ ì‹¬', 'ë°±ì§€ ë³µìŠµ', 'í›„ ìˆœìœ„', 'êµì§ ì´ìˆ˜', 'ë°°ë©´ ë°œê´‘',\n"
        "    'ì „ë©´ ë°œê´‘', 'ì§€ì—­ í˜ì´', 'ì´ˆë“± êµì‚¬', 'ê°€ì§œ ë‰´ìŠ¤', 'ììŒêµ° ë‹¨ìˆœí™”', 'ê¸°ìˆ™ í•™ì›', 'ë§Œêµ­ ê³µë²•', 'ê³µë¶€ ì˜ìš•', 'ë…¸ì¸ ì„±ë¹„',\n"
        "    'ê·¹ ì´ˆë°˜', 'ì—°ê·¹ ì˜í™”ê³¼'\n"
        "- ë‹¤ìŒ ë‹¨ì–´ëŠ” ë°˜ë“œì‹œ **ë¶™ì—¬ ì¨ì•¼ í•´**:\n"
        "  Â· 'ìˆ˜ì‹œì ‘ìˆ˜', 'ì‹œí—˜ê¸°ê°„', 'êµ¬ì¡°ë…í•´', 'ë™í•´ë°”ë‹¤', 'í•™êµìƒí™œ', 'ê³µë¶€ì‹œê°„', 'ì •ì •ê¸°ê°„', 'ì¸êµ¬ìˆ˜', 'ì˜ì‚¬ë¶„', 'íšŒì „ì£¼ê¸°',\n"
        "    'ê³µë¶€ìê·¹', 'ì•…ì„±ì½”ë“œ', 'ë‚˜ë¹„íš¨ê³¼', 'í•„ê¸°ë…¸íŠ¸', 'ì£¼ê²©ì¡°ì‚¬', 'ìˆ˜í•™í•™ì›', 'ì¸ì§€ì‹¬ë¦¬í•™', 'ëŒ€í•™ê³¼ì •', 'í¸ê°€ë¥´ê¸°', 'í•™ìŠµë°©í–¥',\n"
        "    'ì¹˜ê³ ëŠ”ìš”', 'êµìˆ˜ë˜ì‹ ', 'íšŒì „ê´€ì„±', 'íŒŒìƒì ‘ì‚¬', 'ê³¼ì ì‚¬ì§„', 'ì‚¬í˜•ì œë„', 'í†µí•©ê²€ìƒ‰'\n"
        "- ê´€ìš© í‘œí˜„ì€ ë°˜ë“œì‹œ ë¶™ì—¬ ì¨. ì˜ˆ: 'í•´ì£¼ì…¨ë‹¤', 'ë„ì™€ì£¼ì…”ì„œ', 'í•œë°¤ì¤‘'\n"
        "- â€˜ë“¯â€™, â€˜í•´ê°€ì§€ê³ â€™, â€˜í„°ë“í•´ê°€ì§€ê³ â€™ ê°™ì€ í‘œí˜„ì€ ë¬´ì¡°ê±´ ë¶™ì—¬ ì¨ì•¼ í•´.\n\n"

        "3. **ë¬¸ì¥ë¶€í˜¸**\n"
        "- ë¬¸ì¥ ëì— ì¢…ê²° ë¶€í˜¸ê°€ ì—†ìœ¼ë©´ ë¬¸ì¥ ìœ í˜•ì— ë”°ë¼ ë§ˆì¹¨í‘œ(.), ë¬¼ìŒí‘œ(?), ëŠë‚Œí‘œ(!) ì¤‘ í•˜ë‚˜ë¥¼ ì¶”ê°€í•´ì¤˜.\n"
        "- ì‰¼í‘œ(,)ëŠ” ì›ë¬¸ì— ìˆì„ ë•Œë§Œ ìœ ì§€í•˜ê³ , ìƒˆë¡œ ì‚½ì…í•˜ì§€ ë§ˆ.\n"
        "- ìƒëµë¶€í˜¸(...), ë³µí•©ë¶€í˜¸(...?, ..!, ?!, ë“±)ì€ ì›í˜• ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  ìˆ˜ì •í•˜ì§€ ë§ˆ.\n"
        "- ì›ë¬¸ì— ì—†ëŠ” ë”°ì˜´í‘œ, ê´„í˜¸, íŠ¹ìˆ˜ë¶€í˜¸ëŠ” ì‚½ì…í•˜ì§€ ë§ˆ.\n\n"

        "ğŸ“Œ **ì ˆëŒ€ í•˜ì§€ ë§ˆ**\n"
        "- ë§íˆ¬ë‚˜ ê²©ì‹ ë³€ê²½ ê¸ˆì§€: 'ì„ ìƒ' â†’ 'ì„ ìƒë‹˜', 'ê±°' â†’ 'ê²ƒ' âŒ\n"
        "- ì˜ë¯¸ê°€ ê°™ë‹¤ê³  ë‹¨ì–´ ìì²´ë¥¼ ë°”ê¾¸ë©´ ì•ˆ ë¼: 'ìˆì„ê¹Œìš”' â†’ 'ìˆìœ¼ì‹¤ê¹Œìš”', 'ë°‘ì—' â†’ 'ì•„ë˜' âŒ\n"
        "- ì¡°ì‚¬ ì„ì˜ ì¶”ê°€ ê¸ˆì§€. ë‹¨, ì˜¤ë¥˜ëŠ” ê³ ì³ë„ ë¼. (ì˜ˆ: ì´, ê°€, ì„, ë¥¼, ì€, ëŠ”, ë„, ë§Œ, ê¹Œì§€ ë“±)\n"
        "- ë¬¸ì¥ì´ ì–´ìƒ‰í•´ë„ ì˜ë¯¸ê°€ í†µí•˜ë©´ êµ¬ì¡°ë¥¼ ë°”ê¾¸ì§€ ë§ˆ.\n"
        "- ì‰¼í‘œë‚˜ ë”°ì˜´í‘œëŠ” ì›ë¬¸ì— ì—†ìœ¼ë©´ ì ˆëŒ€ ì‚½ì…í•˜ì§€ ë§ˆ.\n\n"

        "ğŸ“Œ **ë°˜ë“œì‹œ ë‹¤ìŒê³¼ ê°™ì´ êµì •í•´ì•¼ í•´**\n"
        "- 'ê·¸ì¹˜ë§Œ' â†’ 'ê·¸ë ‡ì§€ë§Œ'\n"
        "- 'ìŠ¤í—˜ìƒí™œ' â†’ 'ìˆ˜í—˜ìƒí™œ'\n"
        "- 'ì¸ë„¤ì¼' â†’ 'ì„¬ë„¤ì¼'\n"
        "- 'í‰í–‰ ì´ë™' â†’ 'í‰í–‰ì´ë™'\n"
        "- 'ë°”ë€Œì–´ ê°€ì§€ê³ ' â†’ 'ë°”ë€Œì–´ê°€ì§€ê³ '\n"
        "- 'í„°ë“ í•´ê°€ì§€ê³ ' â†’ 'í„°ë“í•´ê°€ì§€ê³ '\n"
        "- 'ë§ëŠ” ë“¯ í•´' â†’ 'ë§ëŠ”ë“¯í•´'\n"
        "- 'ì—†ëŠ” ë“¯' â†’ 'ì—†ëŠ”ë“¯'\n"
        "- 'í•´ ì£¼ì…¨ë‹¤' â†’ 'í•´ì£¼ì…¨ë‹¤'\n"
        "- 'ë„ì™€ ì£¼ì…”ì„œ' â†’ 'ë„ì™€ì£¼ì…”ì„œ'\n"
        "- 'ìª¼ë”'ì€ 'ìª¼ê¸ˆ'ìœ¼ë¡œ, 'ì¡°ê¸ˆ'ì€ 'ì¡°ê¸ˆ' ê·¸ëŒ€ë¡œ ìœ ì§€\n"
        "- 'ë¬¸ì œí’€ì´'ì™€ 'ë¬¸ì œ í’€ì´'ëŠ” ë‘˜ ë‹¤ ë§ìŒ â†’ ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆ\n"
        "- 'íŠ¸ë¦°' â†’ 'í‹€ë¦°'\n"
        "- 'ë©˜ë‚ ' â†’ 'ë§¨ë‚ '\n"
        "- 'ìˆ¨ì°¸êµ¬' â†’ 'ìˆ¨ ì°¸ê³ '\n"
        "- 'í•œê±°ìŒ í•œê±°ìŒ' â†’ 'í•œê±¸ìŒ í•œê±¸ìŒ'\n"
        "- 'ì¬ì‹¬ì¥' â†’ 'ì œ ì‹¬ì¥'\n"
        "- 'ì¹´í˜ì¸ìŒë£Œìˆœ' â†’ 'ì¹´í˜ì¸ ìŒë£Œìˆ˜ëŠ”'\n"
        "- 'ê³ ì¹˜êµ¬ë‚˜ì„œ' â†’ 'ê³ ì¹˜ê³  ë‚˜ì„œ'\n"
        "- 'ê±°ë¦¬ë©´ ê´œì°®ë‹¤' â†’ 'ê±¸ë¦¬ë©´ ê´œì°®ë‹¤'\n"
        "- 'ì´í•´ëª»í• ' â†’ 'ë¯¸í•´ ëª» í• '\n"
        "- 'ë°›ì•˜ì—‡ì–´' â†’ 'ë°›ì•˜ì—ˆì–´'\n"
        "- 'ê³µë§¤ë„ëŠ”ë‹¤ìˆì–ì•„' â†’ 'ê³µë§¤ë„ëŠ” ë‹¤ ìˆì–ì•„'\n"
        "- 'ì‘ì›í•´ì£¼ì…”ì„œ' â†’ 'ì‘ì›í•´ ì£¼ì…”ì„œ'\n"
        "- 'ë°›ì•„ ë“œë¦´' â†’ 'ë°›ì•„ë“œë¦´'\n"
        "- 'ì•„ë‹ˆêµ¬ì„±ì ' â†’ 'ì•„ë‹ˆê³  ì„±ì '\n"
        "- 'ì „ë¬¸í•­' â†’ 'ì „ ë¬¸í•­'\n"
        "- 'ì¡´ì¬í•˜ëŠ”ê±°ë¼' â†’ 'ì¡´ì¬í•˜ëŠ” ê±°ë¼'\n"
        "- 'ë©€' â†’ 'ë­˜'\n"
        "- 'ì ' â†’ 'ì¢€'\n"
        "- 'ê´€ë ¨ìœ¼ë£¨ë‹¤ê°€ìš”' â†’ 'ê´€ë ¨ìœ¼ë¡œë‹¤ê°€ìš”'\n"
        "- 'ì§€ê¸ˆì€ì•ˆë˜ìš”' â†’ 'ì§€ê¸ˆì€ ì•ˆë¼ìš”'\n"
        "- 'ì–´ë–¡í•´ì„¤ì©¡' â†’ 'ì–´ë–»ê²Œ ì„¤ì •'\n"
        "- 'í•™êµê¸‰ê°„' â†’ 'í•™êµê¸‰ ê°„'\n"
        "- 'ê°€ë¼ë©´' â†’ 'ê°€ ë˜ë©´'\n"
        "- 'ê°™ì´ë‚˜ê°€ì‹œëŠ”ë°' â†’ 'ê°™ì´ ë‚˜ê°€ì‹œëŠ”ë°'\n"
        "- 'ê°ì„±ìˆë‹¤ê³  í•œ' â†’ 'ê°ì„± ìˆë‹¤ê³  í•œ'\n"
        "- 'ê±¸ë¦¬ëŠ”ê±´ê°€ìš”' â†’ 'ê±¸ë¦¬ëŠ” ê±´ê°€ìš”'\n"
        "- 'ê³ ì „ì ì´ë¯¸ì—ì„œ' â†’ 'ê³ ì „ì  ì˜ë¯¸ì—ì„œ'\n"
        "- 'ê³µë¶€í• ë•Œì˜' â†’ 'ê³µë¶€í•  ë•Œì˜'\n"
        "- 'ê³µë§¤ë„ëŠ”ë‹¤ìˆì–ì•„.' â†’ 'ê³µë§¤ë„ëŠ” ë‹¤ ìˆì–ì•„.'\n"
        "- 'ê·¸ë¦¬êµ¬ê°„ê²©' â†’ 'ê·¸ë¦¬ê³  ê°„ê²©'\n"
        "- 'ê·¸ë§ë“¤ì–´ë³´ë‹ˆê¹Œ' â†’ 'ê·¸ ë§ ë“¤ì–´ë³´ë‹ˆê¹Œ'\n"
        "- 'ê¸°ëŒ€ë¼ì„œìš”.' â†’ 'ê¸°ëŒ€ë¼ì„œìš”'\n"
        "- 'ëŠë‚Œì´ë‹¬ë¼ì§€ë”ë¼ê³ ìš”.' â†’ 'ëŠë‚Œì´ ë‹¬ë¼ì§€ë”ë¼ê³ ìš”.'\n"
        "- 'ë©˜íƒˆì´ì•½í•´ì¡Œì–´.' â†’ 'ë©˜íƒˆì´ ì•½í•´ì¡Œì–´.'\n"
        "- 'ë°‘ì—ì„œìœ—ì‚¬ëŒ' â†’ 'ë°‘ì—ì„œ ìœ—ì‚¬ëŒ'\n"
        "- 'ë­”ê°€ë¶€ì¡±í•˜ë‹¤' â†’ 'ë­”ê°€ ë¶€ì¡±í•˜ë‹¤'\n"
        "- 'ë°›ì•˜ì—‡ì–´' â†’ 'ë°›ì•˜ì—ˆì–´'\n"
        "- 'ì‚´ì§ë¬´ì„œìš´ê²ƒê°™ì•„ìš”' â†’ 'ì‚´ì§ ë¬´ì„œìš´ ê²ƒ ê°™ì•„ìš”'\n"
        "- 'ìƒê°ì•ˆë‚˜ì„œìš”' â†’ 'ìƒê° ì•ˆ ë‚˜ì„œìš”'\n"
        "- 'ì„±ì¥í•´ê°€ê³ ìˆëŠ”' â†’ 'ì„±ì¥í•´ ê°€ê³  ìˆëŠ”'\n"
        "- 'ìˆ¨ì°¸êµ¬' â†’ 'ìˆ¨ ì°¸ê³ '\n"
        "- 'ì‹œê°„ ê¹¨ ì¤„ì–´ë“¤ì–´ìš”' â†’ 'ì‹œê°„ ê½¤ ì¤„ì–´ë“¤ì–´ìš”'\n"
        "- 'ì‹ ë¢°í• ë§Œí•œì •ë³´ì¸ê°€ìš”?' â†’ 'ì‹ ë¢°í•  ë§Œí•œ ì •ë³´ì¸ê°€ìš”?'\n"
        "- 'ì•„ë‹ˆêµ¬ì„±ì ' â†’ 'ì•„ë‹ˆê³  ì„±ì '\n"
        "- 'ì•ˆë˜êµ¬' â†’ 'ì•ˆ ë˜ê³ '\n"
        "- 'ì–´ë””ê°€ì§€' â†’ 'ì–´ë”” ê°€ì§€'\n"
        "- 'ì–´ë–¡í•´ì„¤ì©¡' â†’ 'ì–´ë–»ê²Œ ì„¤ì •'\n"
        "- 'ì—†ì–´ì§„ê±°ê°™ì•„ìš”.' â†’ 'ì—†ì–´ì§„ ê±° ê°™ì•„ìš”.'\n"
        "- 'ì™œì£ ?' â†’ 'ì™œì£ ?'\n"
        "- 'ì´ê±°ì´' â†’ 'ì´ê²ƒì´'\n"
        "- 'ì´í•´ëª»í• ' â†’ 'ë¯¸í•´ ëª» í• '\n"
        "- 'ìê¸°ìì‹ ì„ë¯¿ìœ¼ì„¸ìš”' â†’ 'ìê¸° ìì‹ ì„ ë¯¿ìœ¼ì„¸ìš”'\n"
        "- 'ì •ë§ì´ìœê²ƒê°™ì•„ìš”' â†’ 'ì •ë§ ì˜ˆìœ ê²ƒ ê°™ì•„ìš”'\n"
        "- 'ì¢‹ì€í•˜ë£¨ë˜ì„¸ìš”' â†’ 'ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”'\n"
        "- 'ì§€ê¸ˆì€ì•ˆë˜ìš”' â†’ 'ì§€ê¸ˆì€ ì•ˆë¼ìš”'\n"
        "- 'ì§€ë‚˜ê°€ë²„ë¦¬ë”ë¼ê³ ìš”.' â†’ 'ì§€ë‚˜ê°€ ë²„ë¦¬ë”ë¼ê³ ìš”.'\n"
        "- 'ì±…ë³´ë‹ˆê¹Œ' â†’ 'ì±… ë³´ë‹ˆê¹Œ'\n"
        "- 'ì¹´í˜ì¸ìŒë£Œìˆœ' â†’ 'ì¹´í˜ì¸ ìŒë£Œìˆ˜ëŠ”'\n"
        "- 'í‘œí˜„í•œê±°ì–ì•„ìš”' â†’ 'í‘œí˜„í•œ ê±°ì–ì•„ìš”'\n"
        "- 'í•˜ë£¨í•˜ë£¨ê°€' â†’ 'í•˜ë£¨í•˜ë£¨ê°€'\n"
        "- 'í•œê±°ìŒ í•œê±°ìŒ' â†’ 'í•œ ê±¸ìŒ í•œ ê±¸ìŒ'\n"
        "- 'í•œë²ˆì—í•´ê²°' â†’ 'í•œ ë²ˆì— í•´ê²°'\n"
        "- 'í•´ì£¼ì…”ì„œ' â†’ 'í•´ ì£¼ì…”ì„œ'\n"
        "- 'ëª†ì‹œê°„ í•˜ì…§' â†’ 'ëŠ” ëª‡ ì‹œê°„ í•˜ì…¨'\n"
        "- 'ë°–ì— ì—†ê² ì£µ' â†’ 'ë°–ì— ì—†ê² ì£ .'\n"
        "- 'í•˜ë£¨ ì˜í•´' â†’ 'í•˜ë£¨ ì˜ í•´ '\n"
        "- 'ê°€ë¥´ì³ ì£¼ìƒˆ' â†’ 'ê°€ë¥´ì³ ì£¼ì„¸'\n"
        "- 'ê°€ì„œ í•´ì•¼ê²Ÿë‹¤' â†’ 'ê°€ì„œ í•´ì•¼ê² ë‹¤.'\n"
        "- 'ê°•ì¢ŒëŠ” ì–¸ì¬' â†’ 'ê°•ì¢ŒëŠ” ì–¸ì œ'\n"
        "- 'ê± ê·¸ëŒ€ë¡œì¼ê±°' â†’ 'ê·¸ëƒ¥ ê·¸ëŒ€ë¡œì¼ ê±° '\n"
        "- 'ê± í•©ì„±í•´ë‘' â†’ 'ê·¸ëƒ¥ í•©ì„±í•´ë„'\n"
        "- 'ê±°' â†’ 'ê±° '\n"
        "- 'ê±° ê°€íƒ€' â†’ 'ê±° ê°™ì•„'\n"
        "- 'ê±° ê°€íƒ€ìš”' â†’ 'ê±° ê°™ì•„ìš”.'\n"
        "- 'ê±°ë„í•˜ê¸°ì‹«ì€' â†’ 'ê²ƒë„ í•˜ê¸° ì‹«ì€ '\n"
        "- 'ê±°ë©´ ì–´ì©”ìˆ˜' â†’ 'ê±°ë©´ ì–´ì©” ìˆ˜ '\n"
        "- 'ê±°ìš”' â†’ 'ê±°ìš”.'\n"
        "- 'ê±°ì´ ë§ëŠ” ì„¤ëª…' â†’ 'ê²ƒì´ ë§ëŠ” ì„¤ëª… '\n"
        "- 'ê±´ ì‚¬ì‹¤ì¸ë°ì˜¤' â†’ 'ê±´ ì‚¬ì‹¤ì¸ë°ìš”'\n"
        "- 'ê²ƒì€ ë§ì§€ì•ˆ' â†’ 'ê²ƒì€ ë§ì§€ ì•Š'\n"
        "- 'ê²Œ ì•„ë‹ˆì£ ' â†’ 'ê²Œ ì•„ë‹ˆì£ .'\n"
        "- 'ê³ ëŸ°ì§€ ì„¤ëª…í•´' â†’ 'ê·¸ëŸ°ì§€ ì„¤ëª…í•´ '\n"
        "- 'êµ¬' â†’ 'ê³ '\n"
        "- ' ê°€ê³ ì‹¶ë„¤ìš”' â†’ 'ì„ ê°€ê³  ì‹¶ë„¤ìš”.'\n"
        "- ' ë‚´ì˜ ì²´ëŒ€ì…ì‹œ' â†’ 'ì˜ ì²´ëŒ€ ì…ì‹œë¥¼'\n"
        "- ' ì•„ë‹ˆê±°ë“ ìš”' â†’ 'ì´ ì•„ë‹ˆê±°ë“ ìš”.'\n"
        "- ' í•˜ë‚˜ ë³¼ë–„' â†’ 'ë¥¼ í•˜ë‚˜ ë³¼ ë•Œ'\n"
        "- ' í• ë–„' â†’ 'í•  ë•Œ'\n"
        "- 'ê°€ì¡±ì´ìƒê¸°ë‹ˆ ì¡°' â†’ ' ê°€ì¡±ì´ ìƒê¸°ë‹ˆ ì¢‹'\n"
        "- 'ê°€íŠ¼ ì¡±ì¸' â†’ ' ê°™ì€ ì¡±ì¸ '\n"
        "- 'ê°–ê³  ê°€ì§€ ì•‰' â†’ ' ê°–ê³  ê°€ì§€ ì•Š'\n"
        "- 'ê°œë¼ê³  ë´ì•¼' â†’ ' ê°œë¼ê³  ë´ì•¼ '\n"
        "- 'ê°œë¥¼ ì—°ìŠµí•´' â†’ ' ê°œë¥¼ ì—°ìŠµí•´ '\n"
        "- 'ê± ê¶ê¸ˆí•´ì„œê·¼' â†’ 'ê·¸ëƒ¥ ê¶ê¸ˆí•´ì„œ ê·¸ëŸ°'\n"
        "- 'ê±”' â†’ 'ê³„'\n"
        "- 'ê±°' â†’ ' ê±° '\n"
        "- 'ê±°' â†’ 'ê²ƒ'\n"
        "- 'ê±° ê°€íƒ€' â†’ ' ê±° ê°™ì•„'\n"
        "- 'ê±° ê°€íŠ¼ë° ì™¸' â†’ ' ê²ƒ ê°™ì€ë° ì™œ'\n"
        "- 'ê±° ê°‡' â†’ ' ê±° ê°™'\n"
        "- 'ê±° ë§ˆëŠ ' â†’ ' ê±° ë§ìŒ.'\n"
        "- 'ê±°ì–´ë–„' â†’ ' ê±° ì–´ë•Œ?'\n"
        "- 'ê±°ì—ìš”' â†’ ' ê±°ì˜ˆìš”.'\n"
        "- 'ê±´ ì˜ëª»ë€' â†’ ' ê±´ ì˜ëª»ëœ'\n"
        "- 'ê±´ê°€ìš”' â†’ ' ê±´ê°€ìš”?'\n"
        "- 'ê±¸ ì•ˆì¡°' â†’ ' ê±¸ ì•ˆ ì¢‹'\n"
        "- 'ê²ë‹ˆë‹¤' â†’ ' ê²ë‹ˆë‹¤.'\n"
        "- 'ê²ƒê°™ìŠµë‹ˆë‹¤' â†’ ' ê²ƒ ê°™ìŠµë‹ˆë‹¤.'\n"
        "- 'ê²…ë¶€ê°€ ë‚¨ì•˜ë‹¤' â†’ 'ê³µë¶€ê°€ ë‚¨ì•˜ë‹¤.'\n"
        "- 'ê²Œ ì¢‹ê±°ë“ ìš”' â†’ ' ê²Œ ì¢‹ê±°ë“ ìš”!'\n"
        "- 'ê²Ÿë‚´ìš”' â†’ 'ê² ë„¤ìš”.'\n"
        "- 'ê³¼ì •ì€ ì™¸ ê°€ì¹˜' â†’ ' ê³¼ì •ì€ ì™œ ê°€ì¹˜ '\n"
        "- 'êµ¬' â†’ 'ê³ '\n"
        "- 'êµ¬ ë¬»ëŠ”' â†’ 'ê³  ë¬»ëŠ” '\n"
        "- 'êµ¬ í• ìˆ˜ì‡' â†’ 'ê³  í•  ìˆ˜ ìˆ'\n"
        "- 'êµ¬ í˜„ëª…í•œ' â†’ 'ê³  í˜„ëª…í•œ '\n"
        "- 'êµ¬ìš”' â†’ 'ê³ ìš”.'\n"
        "- 'êµ¬ì „ì—ì„œ ì ìœ¼ë¡œ' â†’ 'ê³ ì „ì—ì„œ ì ìœ¼ë¡œ '\n"
        "- 'êµ¬í•´ë„ í‹€ë¦°ê±°' â†’ 'ê³  í•´ë„ í‹€ë¦° ê²ƒ'\n"
        "- 'ê·¸ê±°ì„ ì°¸ì•˜ë‹¤ëŠ”' â†’ ' ê·¸ê²ƒì„ ì°¸ì•˜ë‹¤ëŠ” '\n"
        "- 'ê¸€ê³  ì¬' â†’ 'ê·¸ë¦¬ê³  ì œ'\n"
        "- 'ë‚¨ì•˜ë‹¤ê³  ì²´ê°í•´ë”°' â†’ ' ë‚¨ì•˜ë‹¤ê³  ì²´ê°í–ˆë‹¤'\n"
        "- 'ë„ˆë¨¸ã…“ê°ˆì¤„ ì•Œì•„ì•¼' â†’ 'ë„˜ì–´ê°ˆ ì¤„ ì•Œì•„ì•¼ '\n"
        "- 'ë„’ì–´ì§€ëŠ”ë²•ì´ ì‡ì“¸' â†’ 'ë„“ì–´ì§€ëŠ” ë²•ì´ ìˆì„'\n"
        "- 'ë„˜ë¬´ í´ê±°ê°™ì• ' â†’ ' ë„ˆë¬´ í´ ê²ƒ ê°™ì•„'\n"
        "- 'ëŒ€' â†’ 'ë°'\n"
        "- 'ëŒ€ ë¬´ì—‡ì¸ì§€ ê¶ê¸ˆí•¨' â†’ 'ë° ë¬´ì—‡ì¸ì§€ ê¶ê¸ˆí•©'\n"
        "- 'ëŒ€ ì˜ëª»' â†’ 'ë° ì˜ ëª» '\n"
        "- 'ëŒ€ì™¸ ì¤‘ë ¥ì´' â†’ 'ë° ì™œ ì¤‘ë ¥ì´ '\n"
        "- 'ë€ë‹¤' â†’ ' ëœë‹¤.'\n"
        "- 'ë˜ë‹ˆê¹Œìš”' â†’ ' ë˜ë‹ˆê¹Œìš”.'\n"
        "- 'ë“œë¥¼ê¹Œí•˜ëŠ•ë° ì ' â†’ 'ë“¤ì„ê¹Œ í•˜ëŠ”ë° ì¢€'\n"
        "- 'ë–„ í‹°ë¹„' â†’ 'ë•Œ í‹°ë¸Œì´ '\n"
        "- 'ë–»í•˜ì£ ' â†’ 'ë–¡í•˜ì£ ?'\n"
        "- 'ë§ì•„ì„œ ê³ ìƒì„ í–‡' â†’ ' ë§ì•„ì„œ ê³ ìƒì„ í–ˆ'\n"
        "- 'ë§êµ¬ëŠ” ë¯¸ì ë¸' â†’ ' ë§ê³ ëŠ” ë¯¸ì ë¶„'\n"
        "- 'ë§í•´ ìƒíƒœê°€ ê°”' â†’ ' ë§í•´ ìƒíƒœê°€ ê°™'\n"
        "- 'ë¬¸ì œ ê³ ì¹ ë–„' â†’ ' ë¬¸ì œ ê³ ì¹  ë•Œ'\n"
        "- 'ë¯€ ì–´ë ¤ìš°ë©´ ê·¸ëŸ°' â†’ 'ë¬´ ì–´ë ¤ìš°ë©´ ê·¸ëŸ° '\n"
        "- 'ë°›ì•„ì„œ ë“¤ì–´ë³´ì‹œëŠ”' â†’ 'í•´ì„œ ë“¤ì–´ë³´ì‹œëŠ” '\n"
        "- 'ë°©í–¥ë„ ê¶ê¸ˆí•˜ë‚´' â†’ ' ë°©í–¥ë„ ê¶ê¸ˆí•˜ë„¤'\n"
        "- 'ë³´ë©´ ì«Œ' â†’ ' ë³´ë©´ ì¢€'\n"
        "- 'ë³´ì´êµ¬ìš”' â†’ ' ë³´ì´ê³ ìš”.'\n"
        "- 'ë´„ë‹ˆë‹¤' â†’ 'ë´…ë‹ˆë‹¤.'\n"
        "- 'ë´„ë¯¸ë‹¤' â†’ ' ë´„ë‹ˆë‹¤.'\n"
        "- 'ë¶™êµ¬ ë°”ë¡œ êµ°ëŒ€' â†’ ' ë¶™ê³  ë°”ë¡œ êµ°ëŒ€ '\n"
        "- 'ì‚¬ì§„ ì²¨ë¶€í–‡' â†’ ' ì‚¬ì§„ ì²¨ë¶€í–ˆ'\n"
        "- 'ì„œë²„ ìƒê°ë‚˜ë‹ˆ' â†’ ' ì„œë²„ ìƒê°ë‚˜ë„¤'\n"
        "- 'ìˆ˜ëŠ” ì—†ëŠ”ê±°' â†’ ' ìˆ˜ëŠ” ì—†ëŠ” ê²ƒ'\n"
        "- 'ìŠ¤' â†’ ' ìˆ˜ '\n"
        "- 'ìŠ¤ìŠ¤' â†’ 'í•  ìˆ˜ '\n"
        "- 'ì•ˆë˜' â†’ ' ì•ˆ ë¼'\n"
        "- 'ì•Šê² ì§€ë§Œ ê°ì‚¬í•¨' â†’ ' ì•Šê² ì§€ë§Œ ê°ì‚¬í•©'\n"
        "- 'ì•µê°„í•˜ê²Œ í’‰ë‹ˆë‹¤' â†’ 'ì—”ê°„í•˜ê²Œ í’‰ë‹ˆë‹¤.'\n"
        "- 'ì–˜ì „ì—ì‡ë˜ ì¼' â†’ ' ì˜ˆì „ì— ìˆë˜ ì¼ '\n"
        "- 'ì–´ë–¡ê²Œ ì•Œìˆ˜ì‡' â†’ ' ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆ'\n"
        "- 'ì–´ë–¡ì¼€ ë¨¸ë¦¬' â†’ ' ì–´ë–»ê²Œ ë¨¸ë¦¿'\n"
        "- 'ì—„ì—ì„œëŠ” ì–´ë– ì¼€' â†’ 'í—˜ì—ì„œëŠ” ì–´ë–»ê²Œ'\n"
        "- 'ì—' â†’ 'ì˜ˆ'\n"
        "- 'ì™¸ ë†ë…¸ë¥¼' â†’ ' ì™œ ë†ë…¸ë¥¼ '\n"
        "- 'ì™¸ ì§‘ë‹¨ì´' â†’ 'ì™œ ì§‘ë‹¨ì´ '\n"
        "- 'ìœ¼ë¡œ í‘¸ëŠ”' â†’ 'ë¡œ í‘¸ëŠ” '\n"
        "- 'ì´ê²Œ ë—ì¸ê°€ìš”' â†’ ' ì´ê²Œ ëì¸ê°€ìš”?'\n"
        "- 'ì´ëŠ” ì™¤ì¼€' â†’ ' ì´ëŠ” ì™œ '\n"
        "- 'ì´ìœ ë¥¼ ì•Œêµ¬ì‹¶ì”' â†’ ' ì´ìœ ë¥¼ ì•Œê³  ì‹¶ìŠµ'\n"
        "- 'ì‡ëŠ”ë°, ì´' â†’ ' ìˆëŠ”ë°, ì´ '\n"
        "- 'ìëŠ”ê±° ê°€íƒ€ìš”' â†’ ' ìëŠ” ê²ƒ ê°™ì•„ìš”.'\n"
        "- 'ì” ì•ˆì€ë¬¸ì¥ ë‘˜' â†’ 'ì¥, ì•ˆì€ë¬¸ì¥ ë‘˜ '\n"
        "- 'ì¬ ê°œê°•í•´ì„œ ì–¸ì¬' â†’ 'ì œ ê°œê°•í•´ì„œ ì–¸ì œ'\n"
        "- 'ì¬ì¯¤ ë‚˜ì˜¤ë‚˜ìš”' â†’ 'ì œì¯¤ ë‚˜ì˜¤ë‚˜ìš”?'\n"
        "- 'ì§€ê¸ˆì‹œê°„ì´' â†’ ' ì§€ê¸ˆ ì‹œê°„ì´ '\n"
        "- 'í‹€ë¦¬êµ¬' â†’ ' í‹€ë¦¬ê³ '\n"
        "- 'í’€ì—ˆë˜ í•™ìƒì„' â†’ ' í’€ì—ˆë˜ í•™ìƒì…'\n"
        "- 'í• ê±°ê°™ì•„ìš”' â†’ ' í•  ê±° ê°™ì•„ìš”.'\n"
        "- 'í˜ë“ ì§€ê²½ì´' â†’ ' í˜ë“  ì§€ê²½ì´ '\n"

        "- ì´ ì™¸ì—ë„ í‹€ë¦° ì˜ˆì‹œê°€ ë‚˜ì˜¤ë©´ ë°˜ë“œì‹œ ë¬¸ë§¥ì— ë§ê²Œ ê³ ì³ì¤˜.\n\n"

        "ğŸ“Œ **ì ˆëŒ€ ê³ ì¹˜ì§€ ë§ê³  ê·¸ëŒ€ë¡œ ì¶œë ¥í•´ì•¼ í•˜ëŠ” í‘œí˜„ë“¤**\n"
        "- 'ë°”ë¬ë‹¤', 'ê³„ì†í•˜ì…”ìš”', 'ì¢‹ì€ê±´', 'ê°€ë“ê°€ë“', 'ë§ì¶°ë³´ëŠ”', 'ì„¸ë¶€ì •ë³´', 'ë°‘ì¤„í•˜ê³ ', 'ê±°ì„', 'ëª‡ì¸ì§€', 'ì˜í•˜ë©´', 'ë§ë‹¤ë©´'\n\n"

        "ğŸ“Œ **ì¶œë ¥ ê·œì¹™**\n"
        "- ë°˜ë“œì‹œ **êµì •ëœ ë¬¸ì¥ í•œ ì¤„ë§Œ** ì¶œë ¥í•´.\n"
        "- 'ê²°ê³¼:', 'ìˆ˜ì •ëœ ë¬¸ì¥:' ê°™ì€ ì ‘ë‘ì–´ë‚˜ ì„¤ëª…ì€ ì“°ì§€ ë§ˆ.\n"
        "- ì¤„ë°”ê¿ˆ ì—†ì´ ëë‚˜ì•¼ í•˜ê³ , ë°˜ë“œì‹œ ì¢…ê²°ë¶€í˜¸(., ?, !)ë¡œ ëë‚˜ì•¼ í•´.\n"
    )

    return [
        {"role": "system", "content": rule_text},
        {"role": "user", "content": f"ë‹¤ìŒ ë¬¸ì¥ì„ êµì •í•´ì¤˜:\n{text}"}
    ]

# ë¹„ë™ê¸° LLM í˜¸ì¶œ
async def correct_row(template_name: str, text: str) -> str:
    messages = apply_template(template_name, text)
    return await call_llm(messages)

async def run_all(df: pd.DataFrame, template_name: str) -> pd.DataFrame:
    inputs = df["err_sentence"].tolist()
    cor_sentences = await tqdm_asyncio.gather(
        *(correct_row(template_name, text) for text in inputs),
        desc=f"ğŸ”§ [{template_name}] ë¬¸ì¥ êµì • ì¤‘",
        total=len(inputs)
    )
    df["cor_sentence"] = cor_sentences
    return df

# ì‹¤í–‰ ë¡œì§
if __name__ == "__main__":
    template_name = "CHECK_SINGLE"
    input_path = "data/test.csv"
    SAMPLE_SIZE = 10871

    load_dotenv()
    api_key = os.getenv("UPSTAGE_API_KEY_1")

    test_df = pd.read_csv(input_path)

    is_eval_mode = (
        "answer" in test_df.columns or
        "cor_sentence" in test_df.columns or
        "cor_sentence_gt" in test_df.columns
    )

    if "answer" in test_df.columns:
        test_df = test_df.rename(columns={"answer": "cor_sentence_gt"})
    elif "cor_sentence" in test_df.columns:
        test_df = test_df.rename(columns={"cor_sentence": "cor_sentence_gt"})

    if is_eval_mode:
        sample_df = test_df.sample(n=SAMPLE_SIZE, random_state=42).reset_index(drop=True)

        # âœ… 1. í”„ë¡¬í”„íŠ¸ í† í° ìˆ˜ ì‚¬ì „ í™•ì¸
        first_input = sample_df["err_sentence"].iloc[0]
        messages = apply_template(template_name, first_input)
        full_text = "\n".join([msg["content"] for msg in messages])
        token_count = get_upstage_token_count([full_text], api_key)

        print(f"ğŸ” í˜„ì¬ í”„ë¡¬í”„íŠ¸ í† í° ìˆ˜: {token_count} tokens")
        if token_count > 5000:
            print(f"â›” í”„ë¡¬í”„íŠ¸ê°€ {token_count} í† í°ìœ¼ë¡œ 2000 í† í°ì„ ì´ˆê³¼í•˜ì—¬ ì‹¤í–‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
            os._exit(1)

        # âœ… 2. ì •ìƒ ì¶”ë¡  ì§„í–‰
        corrected_df = asyncio.run(run_all(sample_df, template_name))

        pred_df = corrected_df[["id", "err_sentence", "cor_sentence"]]
        true_df = sample_df[["id", "err_sentence", "cor_sentence_gt"]].rename(columns={"cor_sentence_gt": "cor_sentence"})

        print("\nğŸ“Š LCS ê¸°ë°˜ í‰ê°€ ê²°ê³¼ (ìƒ˜í”Œ ì‹¤í–‰)")
        _ = evaluate_correction(true_df, pred_df)

        # ì˜¤ë‹µ ì €ì¥
        error_df = pred_df.copy()
        error_df["ground_truth"] = true_df["cor_sentence"]
        error_df = error_df[error_df["cor_sentence"] != error_df["ground_truth"]]

        error_path = f"errors_{template_name.lower()}.csv"
        error_df.to_csv(error_path, index=False)
        print(f"â— í‹€ë¦° ìƒ˜í”Œ {len(error_df)}ê°œ ì €ì¥ë¨ â†’ {error_path}")

    else:
        corrected_df = asyncio.run(run_all(test_df, template_name))
        output_path = f"submission_{template_name.lower()}.csv"
        corrected_df[["id", "err_sentence", "cor_sentence"]].to_csv(output_path, index=False)
        print(f"\nâœ… ì œì¶œ íŒŒì¼ ì €ì¥ ì™„ë£Œ: {output_path}")

    os._exit(0)
